<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Booha 50 – January Week 2</title>
<meta name="theme-color" content="#0b1530" />
<link rel="icon" type="image/png" href="booha-ghost.png" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700;800;900&display=swap" rel="stylesheet" />
<style>
:root{
  --radius:28px;
  --deep:#0b1530;
}

/* Base */
*{box-sizing:border-box;margin:0;padding:0}
html,body{
  height:100%;
  background:radial-gradient(1200px 800px at 50% -10%,#1e2a55 0%,#0f1a3d 40%,#0b1530 100%);
  color:#fff;
  font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif;
  overflow-x:hidden;
}
.wrapper{
  min-height:100%;
  display:flex;flex-direction:column;align-items:center;
  gap:12px;justify-content:flex-start;
  padding:56px 10px 84px;
}

/* Back to menu */
.back{
  position:fixed;left:10px;top:10px;z-index:1000;
  padding:10px 14px;border-radius:999px;
  border:1px solid #2f3b7a;background:#0c1440;color:#fff;
  font-weight:800;text-decoration:none;
  box-shadow:0 0 18px rgba(124,58,237,.25);
  transition:transform .15s ease
}
.back:hover{transform:translateY(-1px)}
.back:active{transform:scale(.97)}

/* Header */
header{text-align:center;line-height:1.15}
header .line1{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(30px,5.2vw,62px)}
header .line2{margin-top:6px;font-family:'Cinzel',serif;font-weight:800;font-size:clamp(22px,3.6vw,34px)}
header .line3{margin-top:2px;font-family:'Cinzel',serif;font-weight:700;font-size:clamp(18px,3.6vw,28px);opacity:.95}

/* Mode tabs */
.modes{display:flex;flex-wrap:wrap;justify-content:center;gap:12px;margin:14px 0 8px}
.modes .tab{
  background:#0d1b4a;border:1px solid #2b3f8a;border-radius:14px;color:#e6e9ff;
  font-weight:900;padding:12px 16px;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,.35);
  transition:transform .12s ease;font-size:clamp(14px,2.6vw,18px)
}
.modes .tab:hover{transform:translateY(-1px)}
.modes .tab.active[data-num="1"]{background:#ff7eb9;color:#3a0630}
.modes .tab.active[data-num="2"]{background:#8aff80;color:#062614}
.modes .tab.active[data-num="3"]{background:#fff680;color:#3a3206}
.modes .tab.active[data-num="4"]{background:#c77dff;color:#1f0b2c}

/* Stage + Card */
.stage{display:flex;flex-direction:column;align-items:center;gap:18px;padding:6px 12px;width:100%}

.card-outer{width:min(92vw,900px);aspect-ratio:3/2;display:flex;align-items:center;justify-content:center;perspective:1000px;}
.card{
  width:100%;height:100%;border-radius:var(--radius);
  border:3px solid rgba(255,255,255,.25);
  box-shadow:0 30px 80px rgba(0,0,0,.3);
  overflow:hidden;
  background-size:100% 240px;
  animation:stripeDown 6s linear infinite;
  position:relative;
}
@keyframes stripeDown{0%{background-position:0 0;}100%{background-position:0 240px;}}

.face{
  position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;
  border-radius:var(--radius);transition:opacity .5s ease,transform .6s ease;
}
.face.hidden{opacity:0;transform:scale(0.98);}
.face.visible{opacity:1;transform:scale(1);}

/* Font scaling by mode */
.term h2{
  margin:0;font-weight:900;line-height:1.1;color:#000;
  text-shadow:0 0 6px rgba(255,255,255,.9),0 0 18px rgba(255,255,255,.6);
}
.term p{
  margin-top:.7rem;font-weight:700;color:#000;
  text-shadow:0 0 4px rgba(255,255,255,.8),0 0 12px rgba(255,255,255,.5);
}

/* Vocabulary: perfect size */
body[data-mode="vocab"] .term h2{font-size:clamp(52px,10vw,120px);}
body[data-mode="vocab"] .term p{font-size:clamp(30px,5.5vw,48px);}

/* Sentences: slightly smaller */
body[data-mode="sentences"] .term h2{font-size:clamp(38px,7vw,82px);}
body[data-mode="sentences"] .term p{font-size:clamp(26px,4.8vw,38px);}

/* Questions: slightly smaller */
body[data-mode="questions"] .term h2{font-size:clamp(36px,6.5vw,76px);}
body[data-mode="questions"] .term p{font-size:clamp(24px,4.6vw,36px);}

/* Sparkles */
.sparkle{
  position:absolute;width:6px;height:6px;border-radius:50%;
  background:radial-gradient(circle,#fff8b0 0%,#ffd700 40%,transparent 70%);
  opacity:.95;pointer-events:none;animation:sparkleFloat 2.3s ease-out forwards;filter:blur(.5px)
}
@keyframes sparkleFloat{0%{transform:translateY(0) scale(1);opacity:1;}60%{opacity:.9;}100%{transform:translateY(-200px) scale(.5);opacity:0}}

/* Controls */
.controls{display:flex;gap:14px;justify-content:center;flex-wrap:wrap}
.btn{
  padding:14px 18px;border-radius:16px;border:1px solid #e5e7eb;background:linear-gradient(180deg,#fff,#eaeaea);
  font-weight:900;color:#111;cursor:pointer;font-size:clamp(16px,3.2vw,20px);
  box-shadow:0 12px 28px rgba(0,0,0,.28);transition:transform .12s ease
}
.btn:hover{transform:translateY(-1px)}
#speakBtn{
  background:linear-gradient(180deg,#ff4444,#cc0000);color:#fff;border:none;
  box-shadow:0 0 22px rgba(255,0,0,.35);font-size:clamp(20px,4vw,24px)
}

/* Quiz */
.quiz-wrap{width:min(94vw,900px);background:#0b1030;border:1px solid #2a3575;border-radius:18px;
padding:20px;box-shadow:0 24px 70px rgba(0,0,0,.45);position:relative;overflow:hidden}
.qtop{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.qprog,.score{font-weight:900;font-size:clamp(16px,2.8vw,20px)}
.q{background:#0f1544;border:1px solid #2a3575;border-radius:14px;padding:18px}
.q h3{font-size:clamp(24px,4vw,36px);margin-bottom:12px}
.opts{display:grid;gap:14px;margin:14px 0}
.opt{
  background:#0d133a;border:2px solid #2a3575;border-radius:14px;padding:18px;
  color:#e9ecff;font-weight:900;font-size:clamp(18px,3.2vw,26px);cursor:pointer;
  transition:transform .08s ease, box-shadow .15s ease; background-clip:padding-box
}
.opt:hover{transform:translateY(-1px)}
.opt.correct{border-color:#22c55e;background:#0f2a1a}
.opt.wrong{border-color:#ef4444;background:#2a1111}
.explain{margin-top:12px;color:#d7ddff;font-size:clamp(14px,2.4vw,18px)}
.hidden{display:none}

/* Quiz nav */
.qnav{display:flex;justify-content:flex-end;margin-top:12px}
#nextQ{
  padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:linear-gradient(180deg,#fff,#eaeaea);
  font-weight:900;color:#111;cursor:pointer;font-size:clamp(14px,2.8vw,16px);
  box-shadow:0 8px 18px rgba(0,0,0,.25);transition:transform .12s ease
}
#nextQ:hover{transform:translateY(-1px)}

/* Small rainbow confetti */
.confetto{
  position:fixed;width:6px;height:7px;opacity:1;will-change:transform,opacity;
  border-radius:2px;transform:translate3d(0,0,0) rotate(0deg);pointer-events:none;z-index:2000
}

footer{position:fixed;bottom:14px;left:0;right:0;text-align:center;
color:#d1d5db;font-family:'Cinzel',serif;font-size:clamp(14px,2.4vw,18px);opacity:.9}
</style>
</head>
<body data-mode="vocab">
<a href="#" class="back" id="backMenu">⟵ Back to Menu</a>

<div class="wrapper">
  <header>
    <div class="line1">The Boo-riculum</div>
    <div class="line2">January Week 2 : 50 Deck</div>
    <div class="line3">１月第2週 : 50デック</div>
  </header>

  <div class="modes" id="modes">
    <button class="tab active" data-num="1" data-mode="vocab">① Vocabulary 語彙 (20)</button>
    <button class="tab" data-num="2" data-mode="sentences">② Sentences 文 (20)</button>
    <button class="tab" data-num="3" data-mode="questions">③ Questions 質問 (20)</button>
    <button class="tab" data-num="4" data-mode="quiz">④ Quiz クイズ (20)</button>
  </div>

  <!-- Card Stage -->
  <section class="stage" id="cardsStage">
    <div class="card-outer">
      <article class="card" id="card">
        <div id="sparkleContainer"></div>
        <div class="face visible" id="frontFace"><div class="term"><h2 id="frontTitle"></h2></div></div>
        <div class="face hidden" id="backFace"><div class="term"><h2 id="backTitle"></h2><p id="backSub"></p></div></div>
      </article>
    </div>

    <div class="controls">
      <button class="btn" id="prevBtn">❮ Prev</button>
      <button class="btn" id="flipBtn">Flip ⤾</button>
      <button class="btn" id="nextBtn">Next ❯</button>
      <button class="btn" id="speakBtn">▶</button>
    </div>
  </section>

  <!-- Quiz Stage -->
  <section class="stage hidden" id="quizStage">
    <div class="quiz-wrap">
      <div class="qtop"><div class="qprog" id="qprog">1 / 20</div><div class="score" id="score">Score: 0</div></div>
      <div class="q" id="qbox">
        <h3 id="qtext"></h3>
        <div class="opts" id="opts"></div>
        <div class="explain" id="explain"></div>
        <div class="qnav"><button id="nextQ">Next ❯</button></div>
      </div>
    </div>
  </section>
</div>

<footer>Bryan's English School</footer>

<script>
/* Vivid rotating palettes */
const PALETTES=[
  ["#ff007f","#00c3ff","#ffe600","#39ff14","#8b00ff","#ff4d4d"],
  ["#ff4b1f","#1fddff","#f9ed69","#00ff9c","#d16ba5","#8ef6e4"],
  ["#ff6ec7","#5ee6ff","#fff680","#a6f7b2","#c77dff","#7dd3fc"],
  ["#ff9f00","#ff00a6","#00ffe1","#ffee00","#00d9ff","#ff6b6b"],
  ["#ff5f6d","#ffc371","#00c9ff","#92fe9d","#a890fe","#fbc8d4"]
];

/* Build animated candy stripes */
function buildStripeBackground(colors){
  const band=40; let stops=[];
  colors.forEach((c,idx)=>{const start=idx*band;stops.push(`${c} ${start}px ${start+band}px`);});
  const all=stops.concat(stops.map(s=>s.replace(/(\d+)px/g,(m,n)=>(parseInt(n)+band*colors.length)+'px')));
  return `repeating-linear-gradient(180deg,${all.join(',')})`;
}

/* Sparkles when audio plays */
const sparkContainer=document.getElementById("sparkleContainer");
function triggerSparkles(){
  for(let n=0;n<35;n++){
    const s=document.createElement("div");
    s.className="sparkle";
    s.style.left=Math.random()*100+"%";
    s.style.bottom=Math.random()*60+"%";
    s.style.transform=`scale(${0.6+Math.random()*1.4})`;
    s.style.animationDelay=(Math.random()*0.3)+"s";
    sparkContainer.appendChild(s);
    setTimeout(()=>s.remove(),2300);
  }
}

/* Local audio — preload & check all folders */
const audioFolders = ["assets/vocab", "assets/sentences", "assets/questions", "assets/audio"];
const audioCache = {};

/* Preload all mp3 files in known folders */
window.addEventListener("DOMContentLoaded", () => {
  audioFolders.forEach(folder => {
    fetch(folder) // try to read folder listing (works on live servers)
      .then(() => {
        // Preload a few common names if known
        // If you know the file list, you can loop it here later
      })
      .catch(() => {}); // ignore if folder isn't public-listable
  });
});

/* Speak function */
function speak(text){
  if(!text) return;
  const filename = text.toLowerCase().replace(/[^a-z0-9ぁ-んァ-ン一-龯]/g,"") + ".mp3";

  // If already preloaded, play instantly
  if(audioCache[filename]){
    audioCache[filename].currentTime = 0;
    audioCache[filename].play().then(()=>triggerSparkles());
    return;
  }

  // Otherwise, search each folder and cache the first that works
  (async () => {
    for(const folder of audioFolders){
      const path = `${folder}/${filename}`;
      const a = new Audio(path);
      try{
        await a.play();
        triggerSparkles();
        audioCache[filename] = a; // cache for next time
        return;
      }catch{
        // try next folder
      }
    }
    // retry after small delay if not ready
    setTimeout(()=>speak(text), 500);
  })();
}


/* Small rainbow confetti (on correct quiz answers) */
const CONFETTI_COLORS=["#ff004d","#ff7ab6","#ffd300","#00e6ff","#7cff6b","#c77dff","#ff8e00","#00d1b2"];
function burstConfetti(x=window.innerWidth/2, y=window.innerHeight/2){
  const N=28;
  for(let i=0;i<N;i++){
    const d=document.createElement("div");
    d.className="confetto";
    d.style.background=CONFETTI_COLORS[i % CONFETTI_COLORS.length];
    const size = 4 + Math.random()*4;
    d.style.width = size + "px";
    d.style.height = (size*1.1) + "px";
    d.style.left = x + "px";
    d.style.top  = y + "px";
    const angle = Math.random()*2*Math.PI;
    const velocity = 6 + Math.random()*12;
    const dx = Math.cos(angle)*velocity;
    const dy = Math.sin(angle)*velocity - 6;
    const rot = (Math.random()*540-270);
    d.style.transition = "transform 700ms cubic-bezier(.2,.8,.2,1), opacity 800ms ease-out";
    requestAnimationFrame(()=>{
      d.style.transform = `translate(${dx*12}px, ${dy*14}px) rotate(${rot}deg)`;
      d.style.opacity = 0;
    });
    document.body.appendChild(d);
    setTimeout(()=>d.remove(),900);
  }
}

/* --- Content (20/20/20) --- */
const VOCAB = [
  { en:"morning",     jp:"朝",           hira:"あさ" },
  { en:"night",       jp:"夜",           hira:"よる" },
  { en:"breakfast",   jp:"朝ごはん",     hira:"あさごはん" },
  { en:"lunch",       jp:"昼ごはん",     hira:"ひるごはん" },
  { en:"dinner",      jp:"晩ごはん／夕食", hira:"ばんごはん／ゆうしょく" },
  { en:"brush",       jp:"みがく",       hira:"みがく" },
  { en:"wash",        jp:"洗う",         hira:"あらう" },
  { en:"go",          jp:"行く",         hira:"いく" },
  { en:"come",        jp:"来る",         hira:"くる" },
  { en:"sleep",       jp:"寝る",         hira:"ねる" },
  { en:"study",       jp:"勉強する",     hira:"べんきょう する" },
  { en:"homework",    jp:"宿題",         hira:"しゅくだい" },
  { en:"clean",       jp:"そうじする",   hira:"そうじ する" },
  { en:"start",       jp:"始まる／始める", hira:"はじまる／はじめる" },
  { en:"finish",      jp:"終わる／終える", hira:"おわる／おえる" },
  { en:"school",      jp:"学校",         hira:"がっこう" },
  { en:"family",      jp:"家族",         hira:"かぞく" },
  { en:"shower",      jp:"シャワー",     hira:"しゃわー" },
  { en:"toothbrush",  jp:"歯ブラシ",     hira:"はぶらし" },
  { en:"phone",       jp:"スマホ",       hira:"すまほ" }
];

const SENTENCES = [
  { en:"I wake up at seven.", jp:"7時に起きます。", hira:"しちじ に おき ます" },
  { en:"I eat breakfast every day.", jp:"毎日朝ごはんを食べます。", hira:"まいにち あさごはん を たべ ます" },
  { en:"I go to school at eight.", jp:"8時に学校へ行きます。", hira:"はちじ に がっこう へ いき ます" },
  { en:"I take a shower in the morning.", jp:"朝シャワーを浴びます。", hira:"あさ しゃわー を あび ます" },
  { en:"I brush my teeth after meals.", jp:"食後に歯をみがきます。", hira:"しょくご に は を みがき ます" },
  { en:"I study English after dinner.", jp:"夕食の後に英語を勉強します。", hira:"ゆうしょく の あと に えいご を べんきょう します" },
  { en:"I do my homework before bed.", jp:"寝る前に宿題をします。", hira:"ねる まえ に しゅくだい を します" },
  { en:"I help my family in the evening.", jp:"夕方に家族を手伝います。", hira:"ゆうがた に かぞく を てつだい ます" },
  { en:"I clean my room every Sunday.", jp:"毎週日曜日に部屋をそうじします。", hira:"まいしゅう にちようび に へや を そうじ します" },
  { en:"I sleep at ten o’clock.", jp:"10時に寝ます。", hira:"じゅうじ に ね ます" },
  { en:"I sometimes read at night.", jp:"夜にときどき読みます。", hira:"よる に ときどき よみ ます" },
  { en:"I never watch TV before school.", jp:"登校前はテレビを見ません。", hira:"とうこう まえ は てれび を み ません" },
  { en:"I usually eat lunch with friends.", jp:"たいてい友だちと昼ごはんを食べます。", hira:"たいてい ともだち と ひるごはん を たべ ます" },
  { en:"I walk to school every day.", jp:"毎日歩いて学校へ行きます。", hira:"まいにち あるいて がっこう へ いき ます" },
  { en:"I relax after class.", jp:"授業の後にリラックスします。", hira:"じゅぎょう の あと に りらっくす します" },
  { en:"I feed my pet in the morning.", jp:"朝ペットにえさをあげます。", hira:"あさ ぺっと に えさ を あげ ます" },
  { en:"I talk with my family at dinner.", jp:"夕食のとき家族と話します。", hira:"ゆうしょく の とき かぞく と はなし ます" },
  { en:"I check my phone before bed.", jp:"寝る前にスマホを見ます。", hira:"ねる まえ に すまほ を み ます" },
  { en:"I get dressed quickly in the morning.", jp:"朝すぐに着替えます。", hira:"あさ すぐ に きがえ ます" },
  { en:"I rest after doing my homework.", jp:"宿題をした後で休みます。", hira:"しゅくだい を した あと で やすみ ます" }
];

const QUESTIONS = [
  { en:"What time do you wake up?", jp:"何時に起きますか。", hira:"なんじ に おき ます か" },
  { en:"What do you do after school?", jp:"放課後は何をしますか。", hira:"ほうかご は なに を します か" },
  { en:"Do you help at home?", jp:"家で手伝いをしますか。", hira:"いえ で てつだい を します か" },
  { en:"What do you do every morning?", jp:"毎朝何をしますか。", hira:"まいあさ なに を します か" },
  { en:"What time do you eat dinner?", jp:"何時に晩ごはんを食べますか。", hira:"なんじ に ばんごはん を たべ ます か" },
  { en:"Do you use your phone before bed?", jp:"寝る前にスマホを使いますか。", hira:"ねる まえ に すまほ を つかい ます か" },
  { en:"How do you get ready for school?", jp:"どうやって学校の準備をしますか。", hira:"どうやって がっこう の じゅんび を します か" },
  { en:"What is your favorite part of the day?", jp:"一日の中で一番好きな時間は何ですか。", hira:"いちにち の なか で いちばん すき な じかん は なん です か" },
  { en:"When do you do homework?", jp:"いつ宿題をしますか。", hira:"いつ しゅくだい を します か" },
  { en:"Do you study every day?", jp:"毎日勉強しますか。", hira:"まいにち べんきょう します か" },
  { en:"What time do you go to bed?", jp:"何時に寝ますか。", hira:"なんじ に ね ます か" },
  { en:"What do you do on weekends?", jp:"週末は何をしますか。", hira:"しゅうまつ は なに を します か" },
  { en:"What do you usually eat for breakfast?", jp:"朝ごはんはふつう何を食べますか。", hira:"あさごはん は ふつう なに を たべ ます か" },
  { en:"Who do you spend time with after school?", jp:"放課後は誰と過ごしますか。", hira:"ほうかご は だれ と すごし ます か" },
  { en:"What time do you finish dinner?", jp:"晩ごはんは何時に終わりますか。", hira:"ばんごはん は なんじ に おわり ます か" },
  { en:"What time do you leave home for school?", jp:"何時に家を出ますか。", hira:"なんじ に いえ を で ます か" },
  { en:"Do you take a shower in the morning or at night?", jp:"シャワーは朝と夜どちらに浴びますか。", hira:"しゃわー は あさ と よる どちら に あび ます か" },
  { en:"How long do you study every day?", jp:"毎日どのくらい勉強しますか。", hira:"まいにち どのくらい べんきょう します か" },
  { en:"What do you like to do before bed?", jp:"寝る前に何をするのが好きですか。", hira:"ねる まえ に なに を する の が すき です か" },
  { en:"Do you walk or ride to school?", jp:"学校へ歩いて行きますか、それとも自転車ですか。", hira:"がっこう へ あるいて いき ます か それとも じてんしゃ です か" }
];

const QUIZ = [
  { q:"I ___ up at seven every morning.", opts:["wake","wakes","am wake","woke"], a:0, ex:"Simple present → I wake up." },
  { q:"She ___ breakfast at eight.", opts:["eat","eats","is eat","ate"], a:1, ex:"He/She/It → add -s to the verb." },
  { q:"We ___ to school by bus.", opts:["go","goes","going","gone"], a:0, ex:"Plural subject → base form 'go'." },
  { q:"He usually ___ a shower before bed.", opts:["take","takes","is taking","took"], a:1, ex:"Simple present habitual action → takes." },
  { q:"I ___ my teeth after meals.", opts:["brush","brushes","brushing","brushed"], a:0, ex:"First person → base form 'brush'." },
  { q:"They ___ their homework after dinner.", opts:["do","does","doing","did"], a:0, ex:"Plural subject → base form 'do'." },
  { q:"My brother ___ TV before school.", opts:["don’t watch","isn’t watch","doesn’t watch","no watch"], a:2, ex:"Negative → doesn’t + base verb." },
  { q:"What time ___ you go to bed?", opts:["do","does","are","is"], a:0, ex:"Question with 'you' → do + base verb." },
  { q:"She ___ at ten o’clock every night.", opts:["sleep","sleeps","sleeping","is sleep"], a:1, ex:"He/She/It → sleeps." },
  { q:"We sometimes ___ lunch together.", opts:["eat","eats","eating","is eat"], a:0, ex:"Plural subject → eat." },
  { q:"He ___ his family in the evening.", opts:["help","helps","is help","helping"], a:1, ex:"He/She/It → add -s to the verb." },
  { q:"I ___ my room every Sunday.", opts:["clean","cleans","is clean","cleaned"], a:0, ex:"Simple present routine → clean." },
  { q:"They ___ English after dinner.", opts:["study","studies","studying","is study"], a:0, ex:"Plural → study." },
  { q:"My friends and I ___ to school together.", opts:["walk","walks","walking","walked"], a:0, ex:"Plural subject → walk." },
  { q:"He ___ up early on weekends.", opts:["get","gets","getting","got"], a:1, ex:"He/She/It → gets." },
  { q:"I ___ breakfast every morning.", opts:["don’t eat","doesn’t eat","not eat","didn’t eat"], a:0, ex:"Negative → don’t + base verb." },
  { q:"What do you ___ after school?", opts:["do","doing","does","to do"], a:0, ex:"Question → do + subject + base verb." },
  { q:"She ___ her phone before bed.", opts:["use","uses","is use","using"], a:1, ex:"He/She/It → uses." },
  { q:"They ___ their hands before eating.", opts:["wash","washes","washing","was"], a:0, ex:"Plural → wash." },
  { q:"I ___ TV before school.", opts:["never watch","don’t watch never","never watches","not watch"], a:0, ex:"Adverb 'never' comes before the main verb." }
];
  
/* Helpers */
function shuffle(arr){const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
let MODE="vocab",idx=0,showBack=false,score=0,qIndex=0,firstAttempt=true,gotIt=false;

const card=document.getElementById('card'),
      frontFace=document.getElementById('frontFace'),
      backFace=document.getElementById('backFace'),
      frontTitle=document.getElementById('frontTitle'),
      backTitle=document.getElementById('backTitle'),
      backSub=document.getElementById('backSub'),
      cardsStage=document.getElementById('cardsStage'),
      quizStage=document.getElementById('quizStage'),
      qprog=document.getElementById('qprog'),
      scoreEl=document.getElementById('score'),
      qtext=document.getElementById('qtext'),
      opts=document.getElementById('opts'),
      explain=document.getElementById('explain');

let VOCAB_RUN=shuffle(VOCAB),SENT_RUN=shuffle(SENTENCES),QUES_RUN=shuffle(QUESTIONS),QUIZ_RUN=[];

function activeList(){return MODE==="vocab"?VOCAB_RUN:MODE==="sentences"?SENT_RUN:QUES_RUN}

function renderCard(){
  const c=activeList()[idx];
  const palette=PALETTES[idx % PALETTES.length]; // vivid change on every card
  card.style.backgroundImage=buildStripeBackground(palette);
  frontTitle.textContent=c.en;
  backTitle.textContent=c.jp;
  backSub.textContent=c.hira;
  if(showBack){
    frontFace.classList.replace("visible","hidden");
    backFace.classList.replace("hidden","visible");
  }else{
    backFace.classList.replace("visible","hidden");
    frontFace.classList.replace("hidden","visible");
  }
}

/* Tabs */
document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  MODE=b.dataset.mode;
  document.body.setAttribute('data-mode', MODE); // ensures correct font scaling
  idx=0; showBack=false;
  if(MODE==="quiz"){
    cardsStage.classList.add('hidden');
    quizStage.classList.remove('hidden');
    startQuiz();
  }else{
    quizStage.classList.add('hidden');
    cardsStage.classList.remove('hidden');
    renderCard();
  }
});

/* Quiz */
function startQuiz(){QUIZ_RUN=shuffle(QUIZ);score=0;qIndex=0;scoreEl.textContent="Score: 0";showQ();}
function showQ(){
  firstAttempt=true;gotIt=false;
  const item=QUIZ_RUN[qIndex];
  qprog.textContent=`${qIndex+1}/${QUIZ_RUN.length}`;
  qtext.textContent=item.q;opts.innerHTML="";explain.textContent="";
  item.opts.forEach((t,i)=>{
    const b=document.createElement('button');
    b.className='opt';b.textContent=t;
    b.onclick=()=>{
      if(gotIt) return;
      const correct=i===item.a;
      if(correct){
        b.classList.add('correct');
        gotIt=true;
        if(firstAttempt) score++;
        scoreEl.textContent=`Score: ${score}`;
        explain.textContent=item.ex;
        const r=b.getBoundingClientRect();
        burstConfetti(r.left + r.width/2, r.top + r.height/2);
        [...opts.children].forEach(btn=>btn.disabled=true);
      }else{
        b.classList.add('wrong');
        firstAttempt=false;
      }
    };
    opts.appendChild(b);
  });
}
document.getElementById('nextQ').onclick=()=>{
  if(qIndex<QUIZ_RUN.length-1){qIndex++;showQ();}
  else{
    qtext.textContent="Finished! Great job.";
    opts.innerHTML="";
    explain.innerHTML=`Your final score <b>${score}</b> / ${QUIZ.length}`;
  }
};

/* Card controls */
document.getElementById('flipBtn').onclick=()=>{showBack=!showBack;renderCard();}
document.getElementById('nextBtn').onclick=()=>{idx=(idx+1)%activeList().length;showBack=false;renderCard();}
document.getElementById('prevBtn').onclick=()=>{idx=(idx-1+activeList().length)%activeList().length;showBack=false;renderCard();}

/* Audio (no quiz) */
document.getElementById('speakBtn').onclick=()=>{
  if(MODE==="quiz") return;
  const c=activeList()[idx];
  speak(showBack ? c.jp : c.en);
};

/* Back to menu */
document.getElementById('backMenu').onclick=(e)=>{
  e.preventDefault();
  if(document.referrer){window.history.back();}else{window.location.href='index.html';}
};

/* Initial render */
renderCard();
</script>
</body>
</html>
